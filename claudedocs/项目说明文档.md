# 1QFM - 智能音乐电台系统项目文档

---

## 一、项目概览与设计理念

### 1.1 项目愿景与目标

**1QFM** 是一个面向音乐爱好者和数字专辑收藏家的现代化个人音乐电台平台。项目核心目标在于打造一个**轻量级、智能化、个性化**的音乐管理与播放生态系统，为用户提供完整的音乐资产管理解决方案。

**核心设计理念：**

- **极致轻量**：摒弃臃肿的商业音乐软件设计，专注于核心功能，前端压缩后体积小于2MB
- **本地优先**：支持用户完整管理本地音乐文件（如抓轨FLAC、WAV等无损音频），摆脱云端依赖
- **智能增强**：通过AI助手"小Q"实现自然语言音乐搜索和推荐，降低用户操作成本
- **社交创新**：聊天室共享听歌功能，让音乐不再是孤独的体验
- **技术前瞻**：采用HLS流媒体协议、三级缓存架构、WebSocket实时通信等现代技术栈

### 1.2 项目愿景远景规划

**短期目标（当前版本）：**
- [已完成] 完善本地音乐库管理功能（专辑、播放列表、曲目管理）
- [已完成] 实现AI智能助手聊天与音乐推荐功能
- [已完成] 建立稳定的音频流处理与缓存系统
- [已完成] 完成用户认证与数据隔离体系

**中期目标（未来6-12个月）：**
- [计划中] 聊天室实时多人听歌同步功能（WebSocket房间系统）
- [计划中] 音乐社交功能（歌单分享、评论系统、用户关注）
- [计划中] 高级音频处理（EQ均衡器、音频标签编辑、格式转换）
- [计划中] 移动端原生应用（iOS/Android）

**长期愿景：**
- [研究中] 建立去中心化音乐共享网络（P2P音乐传输）
- [研究中] AI音乐分析与自动标签化（情绪识别、风格分类）
- [研究中] 跨平台同步与云端备份
- [研究中] 音乐创作者支持平台（直连艺术家与听众）

---

## 二、核心功能体系

### 2.1 本地音乐资产管理系统

**痛点分析：**
市面主流音乐平台（Apple Music、Spotify、网易云音乐）均以流媒体订阅为核心商业模式，对本地音乐文件支持不足：
- **Apple Music**：本地音乐与云音乐库混淆，专辑管理混乱
- **Spotify**：本地文件支持极弱，无法自定义专辑封面和元数据
- **网易云音乐**：本地音乐播放功能形同虚设，无专辑分组

**我们的解决方案：**

#### 2.1.1 专辑管理（Album Management）
- **批量上传**：支持拖拽上传整张专辑的音频文件
- **元数据编辑**：自定义专辑名称、艺术家、封面图片、发行年份
- **曲目排序**：拖拽调整曲目顺序，支持多碟片专辑管理
- **格式支持**：FLAC、WAV、MP3、AAC、OGG等主流音频格式

#### 2.1.2 智能三级缓存架构
为保证高并发播放性能，系统采用分层缓存策略：

1. **L1 - 临时文件缓存**
   - 上传音频文件立即进入临时存储（`/tmp`目录）
   - 支持断点续传和并发上传
   - 自动清理过期文件（24小时TTL）

2. **L2 - Redis热点数据缓存**
   - 播放列表状态（用户当前播放曲目、进度）
   - 搜索结果缓存（网易云API响应，30分钟TTL）
   - 用户会话数据（JWT Token验证结果）

3. **L3 - MinIO对象存储**
   - 音频文件持久化存储
   - HLS分片文件存储（`.m3u8`和`.ts`文件）
   - 专辑封面图片存储
   - 支持跨区域备份和CDN加速

#### 2.1.3 HLS流媒体处理引擎
基于FFmpeg的自动音频转码系统：

```
原始音频文件 → FFmpeg转码 → HLS分片（4秒/片）→ MinIO存储
           ↓
     异步任务队列（防止阻塞用户上传）
           ↓
     Redis缓存播放地址 → 客户端HLS.js播放
```

**技术优势：**
- 支持无损音频实时转码为适合网络传输的码率
- 4秒分片设计平衡首播延迟与流畅度
- 客户端自适应码率调整（根据网络状况）

---

### 2.2 AI智能助手"小Q"

**市场空白分析：**
现有音乐平台的搜索和推荐系统存在以下问题：
- **机械式关键词匹配**：无法理解自然语言表达（如"适合雨天听的安静歌曲"）
- **推荐算法黑箱**：用户无法干预推荐逻辑，缺乏透明度
- **无情感交互**：冰冷的UI界面，缺少陪伴感

**"小Q"的创新设计：**

#### 2.2.1 自然语言音乐搜索
- **情景化查询**："推荐适合晚上开车听的电子乐"
- **情绪识别**："心情不好，想听点治愈的歌"
- **模糊描述**："那首歌词里有'星空'和'流浪'的歌"

#### 2.2.2 流式对话响应
采用WebSocket实现AI回复的打字机效果：
```
用户输入 → WebSocket建立 → AI流式生成 → 逐字展示
                          ↓
                   检测<search_music>标签 → 实时触发搜索
                          ↓
                   返回歌曲卡片 → 点击即播放
```

**关键技术细节：**
- **超时分层处理**：软超时（8秒）提示"思考中"，硬超时（30秒）提示可重试
- **标签解析引擎**：实时解析AI回复中的`<search_music>歌名 歌手</search_music>`标签
- **防重复触发**：确保每次对话只搜索1首歌曲，避免流量浪费

#### 2.2.3 对话历史持久化
- 数据库存储用户完整对话记录（ChatMessage表）
- 支持跨会话恢复上下文（SessionID关联）
- 歌曲卡片数据持久化（JSON格式存储在Songs字段）

---

### 2.3 聊天室共享听歌功能（未来特性）

**创新点说明：**

市面现有音乐软件均缺少**实时同步听歌社交功能**。虽然部分产品有"一起听"功能，但存在以下问题：
- **Spotify Group Session**：仅限Premium订阅用户，且需同一物理位置
- **Apple Music SharePlay**：仅限Apple生态，需FaceTime通话
- **QQ音乐一起听**：需要好友关系，无公开聊天室

**我们的设计方案（技术预研）：**

#### 2.3.1 WebSocket房间系统架构
```
用户A创建房间 → 生成房间ID → 分享链接
                    ↓
用户B、C、D加入 → WebSocket订阅房间频道
                    ↓
用户A播放歌曲 → 广播播放指令（曲目ID + 时间戳）
                    ↓
所有用户同步播放 → 实时同步进度条（心跳机制）
```

#### 2.3.2 时间同步算法
采用NTP风格的时间校准机制：
```
客户端时间 - 服务器时间 = 时间偏移量
播放位置 = 基准时间戳 + (当前时间 - 开始时间) - 偏移量
```

#### 2.3.3 实时聊天与弹幕
- 文字聊天（支持Emoji）
- 音乐评论弹幕（滚动展示）
- 点歌请求机制（投票系统）

---

## 三、技术架构深度解析

### 3.1 后端技术栈

#### 3.1.1 核心框架与语言
- **Golang 1.24+**：高并发性能，协程模型天然适配WebSocket和流处理
- **Gorilla Mux**：轻量级HTTP路由，支持RESTful设计
- **GORM**：ORM框架，支持MySQL连接池和事务管理

#### 3.1.2 数据层
**MySQL 8.0+**（关系型数据库）
- 用户表（users）：用户认证信息（bcrypt密码加密）
- 专辑表（albums）：专辑元数据
- 曲目表（tracks）：音频文件信息与HLS地址
- 聊天会话表（chat_sessions）：AI对话会话管理
- 聊天消息表（chat_messages）：完整对话记录与歌曲卡片数据

**Redis 6.0+**（缓存与会话）
- 播放列表（Sorted Set）：用户当前播放队列
- JWT Token黑名单（String + TTL）：注销Token管理
- 搜索结果缓存（Hash + TTL）：减少外部API调用

**MinIO**（对象存储）
- 音频文件持久化存储
- HLS分片文件存储
- 图片资源存储（封面、头像）

#### 3.1.3 音频处理
- **FFmpeg 4.0+**：音频转码引擎
  - 输入格式：FLAC、WAV、MP3、AAC
  - 输出格式：HLS（HTTP Live Streaming）
  - 编码参数：AAC 128kbps ~ 320kbps，4秒分片

#### 3.1.4 日志与监控
- **Zap Logger**：结构化日志，支持日志分级和轮转
- **Lumberjack**：日志文件切割和压缩

### 3.2 前端技术栈

#### 3.2.1 核心框架
- **React 18**：声明式UI框架
- **TypeScript**：类型安全，减少运行时错误
- **Vite**：构建工具，ESM原生支持，热更新速度快

#### 3.2.2 UI与交互
- **Tailwind CSS**：实用优先的CSS框架
- **Lucide React**：轻量级图标库（tree-shaking友好）
- **HLS.js**：浏览器端HLS播放库
- **Lottie React**：动画渲染（加载动画、音乐可视化）

#### 3.2.3 状态管理
- **React Context API**：
  - `AuthContext`：用户登录状态
  - `PlayerContext`：播放器状态（当前曲目、播放模式、音量）
  - `ToastContext`：全局消息提示

#### 3.2.4 路由与页面
- **React Router DOM 7**：客户端路由
- 页面结构：
  - `/login`：登录注册页
  - `/library`：音乐库页面（专辑网格展示）
  - `/bot`：AI助手聊天页面（Discord风格UI）
  - `/playlist`：播放列表管理
  - `/settings`：用户设置（主题切换、账号管理）

### 3.3 DevOps与部署架构

#### 3.3.1 CI/CD流程
**GitHub Actions自动化流水线：**

1. **代码推送触发**（master分支）
2. **前端构建**：
   - `npm install` → `vite build`
   - 产物压缩并优化（Gzip + Brotli）
3. **后端编译**：
   - Go多阶段构建（减小镜像体积）
   - 编译优化参数：`-ldflags="-s -w"`
4. **Docker镜像构建**：
   - 基础镜像：`golang:1.24-alpine`（构建阶段）
   - 运行镜像：`alpine:latest` + `ffmpeg`
   - 多架构支持：`linux/amd64`（预留arm64支持）
5. **镜像推送**：
   - Docker Hub：`zzhihong/1qfm:latest`
   - GitHub Container Registry：`ghcr.io/zzhihon/bt1qfm:latest`
6. **自动部署**：
   - SSH连接生产服务器
   - 拉取最新镜像
   - `docker compose up -d`滚动更新
   - 清理旧镜像

#### 3.3.2 生产环境架构
```
用户请求 → Nginx反向代理（SSL终止、Gzip压缩）
            ↓
       1QFM后端服务（Docker容器）
            ↓
    +-------+-------+-------+
    |       |       |       |
  MySQL   Redis   MinIO  FFmpeg
（持久化）（缓存）（存储）（转码）
```

**Nginx配置要点：**
- HTTP/2支持
- WebSocket代理（`Upgrade`头处理）
- 静态资源缓存（前端bundle缓存7天）
- 音频流文件缓存（HLS分片缓存1小时）

#### 3.3.3 Docker Compose编排
```yaml
services:
  backend:
    image: zzhihong/1qfm:latest
    depends_on:
      - mysql
      - redis
      - minio
    volumes:
      - ./cache:/app/cache  # 临时文件缓存
      - ./logs:/app/logs    # 日志持久化
    environment:
      - DB_HOST=mysql
      - REDIS_HOST=redis
      - MINIO_ENDPOINT=minio:9000

  mysql:
    image: mysql:8.0
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:6.0-alpine

  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
```

---

## 四、市场需求分析与差异化竞争

### 4.1 目标用户画像

**核心用户群体：**
1. **音乐发烧友**：拥有大量FLAC/WAV无损音乐文件，需要专业管理工具
2. **数字专辑收藏者**：从Bandcamp、Beatport购买数字专辑，需要统一播放平台
3. **抓轨爱好者**：使用EAC、dBpoweramp抓取CD音轨，需要本地播放器
4. **隐私意识用户**：不信任云音乐平台的版权审查和数据收集
5. **技术极客**：喜欢自建服务，对开源软件有偏好

### 4.2 市场空白与机会

#### 4.2.1 本地音乐管理缺失
| 平台 | 本地音乐支持 | 专辑管理 | 元数据编辑 | 无损格式 |
|------|-------------|---------|-----------|---------|
| **Apple Music** | 有限 | 混乱 | 不支持 | 支持 |
| **Spotify** | 极弱 | 无 | 不支持 | 不支持 |
| **网易云音乐** | 形同虚设 | 无分组 | 不支持 | 仅在线 |
| **1QFM** | 完整 | 专业 | 完整 | 完整 |

#### 4.2.2 AI音乐助手空白
现有音乐平台的"智能推荐"本质是协同过滤算法，无法理解自然语言：
- 无法回答"下雨天适合听什么歌"
- 无法根据用户情绪实时调整
- 推荐结果缺乏解释性

**1QFM的AI助手优势：**
- 自然语言理解（基于LLM）
- 上下文记忆（对话历史分析）
- 推荐解释性（告知推荐理由）

#### 4.2.3 社交听歌功能缺失
虽然部分平台有"一起听"功能，但限制极多：
- **Spotify Group Session**：仅限Premium用户，需同一WiFi
- **Apple SharePlay**：需FaceTime通话，仅Apple设备
- **QQ音乐一起听**：需好友关系，无公开房间

**1QFM的设计优势：**
- 公开聊天室（无需好友关系）
- 跨平台支持（Web + 移动端）
- 实时弹幕互动

---

## 五、创意萌芽与产品演进

### 5.1 项目起源故事

**第一阶段：个人抓轨需求（2023年初）**

项目发起人是一位古典音乐爱好者，拥有大量CD收藏。在使用EAC抓取CD音轨后，发现市面音乐软件均无法很好地管理本地FLAC文件：
- Apple Music的"匹配"功能会错误识别专辑
- 网易云音乐的本地播放器界面简陋
- Foobar2000虽然专业，但界面过时且缺少现代功能

**初始需求明确：**
> "我需要一个现代化的Web音乐播放器，能完美管理我的抓轨FLAC文件，支持专辑封面、元数据编辑，并且可以在任何设备访问。"

**第二阶段：技术选型与原型（2023年中）**

- 选择Go语言作为后端（考虑并发性能和部署便利性）
- 选择React作为前端（生态成熟，组件化开发效率高）
- 引入HLS流媒体技术（解决大文件传输和跨平台兼容问题）
- 开发第一版专辑上传和播放功能

**第三阶段：AI助手灵感（2023年底）**

在ChatGPT爆火后，项目成员提出：
> "为什么不能用AI来帮助搜索和推荐音乐？传统搜索框太机械了，我想用自然语言表达我的需求。"

**技术调研与实现：**
- 集成OpenAI API（后改为兼容多模型）
- 设计`<search_music>`标签系统（让AI输出可解析的指令）
- 实现WebSocket流式对话（提升用户体验）
- 开发对话历史持久化（跨会话记忆）

**第四阶段：社交听歌构想（2024年）**

在使用Discord语音频道时，团队成员意识到：
> "为什么不能像Discord一样，有一个聊天室，大家可以一起听音乐、实时互动？"

**概念验证：**
- 技术预研WebSocket房间系统
- 设计时间同步算法
- 原型开发弹幕系统

**当前状态：**
聊天室功能已完成技术预研，计划在v2.0版本正式上线。

### 5.2 产品哲学

**核心价值观：**
1. **用户数据主权**：用户拥有自己的音乐文件，不依赖任何云服务
2. **技术开放性**：开源核心代码，允许社区贡献
3. **体验至上**：即使是小众需求，也要做到体验极致
4. **社区驱动**：倾听用户反馈，快速迭代

**设计原则：**
- **极简主义**：只做必要的功能，拒绝功能臃肿
- **性能优先**：3秒完成页面加载，1秒开始播放
- **无障碍访问**：支持键盘导航和屏幕阅读器
- **响应式设计**：完美适配桌面、平板、手机

---

## 六、技术创新点总结

### 6.1 架构创新
- **三级缓存系统**：平衡性能与成本，命中率达99%+
- **HLS流媒体**：支持无损音频实时转码和自适应码率
- **WebSocket长连接**：AI对话流式响应和实时音乐同步

### 6.2 功能创新
- **AI音乐助手**：自然语言搜索和情感化推荐
- **标签解析引擎**：实时解析AI输出的音乐搜索指令
- **聊天室同步听歌**：多人实时同步播放（未来特性）

### 6.3 工程创新
- **GitHub Actions全自动部署**：代码推送到生产环境仅需5分钟
- **Docker多阶段构建**：镜像体积优化至150MB
- **前后端分离架构**：独立部署和扩展

---

## 七、未来发展路线图

### 7.1 近期目标（3个月内）
- [ ] 完善聊天室功能（WebSocket房间系统）
- [ ] 移动端响应式优化（PWA支持）
- [ ] 高级音频处理（EQ均衡器）
- [ ] 歌词显示与同步

### 7.2 中期目标（6-12个月）
- [ ] iOS/Android原生应用
- [ ] 音乐社交功能（歌单分享、评论）
- [ ] 跨设备同步（播放进度、播放列表）
- [ ] 高级AI功能（情绪识别、音乐生成）

### 7.3 长期愿景（1年以上）
- [ ] 去中心化音乐网络（P2P传输）
- [ ] 音乐创作者平台（直连艺术家）
- [ ] 开放API生态（第三方插件）
- [ ] 多语言国际化支持

---

## 八、结语

**1QFM** 不仅是一个音乐播放器，更是对现有音乐平台商业模式的反思与挑战。我们相信：

> **音乐应该属于用户，而不是平台。**
> **技术应该服务于体验，而不是商业化。**
> **社区应该共建共享，而不是被动消费。**

在流媒体时代，我们选择站在音乐爱好者一边，打造一个真正为用户服务的音乐平台。

**作者**：1QFM开发团队
