name: Frontend Deploy

on:
  push:
    branches:
      - master
    paths:
      - 'web/ui/**'
  workflow_dispatch:

permissions:
  contents: read

env:
  NODE_VERSION: '20'
  DEPLOY_PATH: /opt/docker_file/website/nginx_website/website_file/1qfm

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Enable Corepack (for Yarn 4)
      run: corepack enable

    - name: Install dependencies
      working-directory: web/ui
      env:
        YARN_ENABLE_IMMUTABLE_INSTALLS: false
      run: yarn install

    - name: Build
      working-directory: web/ui
      run: yarn build

    - name: Package dist
      working-directory: web/ui
      run: tar -czvf dist.tar.gz dist/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: web/ui/dist.tar.gz
        retention-days: 7

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: success()

    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: frontend-dist

    - name: Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT }}
        timeout: 60s
        command_timeout: 5m
        script: |
          echo "ðŸš€ å¼€å§‹éƒ¨ç½²å‰ç«¯..."
          cd ${{ env.DEPLOY_PATH }}

          echo "ðŸ“¦ å¤‡ä»½æ—§ç‰ˆæœ¬..."
          if [ -d "dist" ]; then
            sudo rm -rf dist.backup
            sudo mv dist dist.backup
          fi

          echo "âœ… å‡†å¤‡æŽ¥æ”¶æ–°æ–‡ä»¶..."

    - name: Copy dist to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT }}
        source: "dist.tar.gz"
        target: ${{ env.DEPLOY_PATH }}

    - name: Extract and finalize deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT }}
        timeout: 60s
        command_timeout: 5m
        script: |
          cd ${{ env.DEPLOY_PATH }}

          echo "ðŸ“¦ è§£åŽ‹æ–°ç‰ˆæœ¬..."
          sudo tar -xzvf dist.tar.gz

          echo "ðŸ”§ è®¾ç½®æƒé™..."
          sudo chmod -R 755 dist/
          sudo chown -R root:root dist/

          echo "ðŸ§¹ æ¸…ç†..."
          rm -f dist.tar.gz

          echo "âœ… å‰ç«¯éƒ¨ç½²å®Œæˆ!"
          ls -la dist/

    - name: Rollback on failure
      if: failure()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT }}
        timeout: 60s
        script: |
          cd ${{ env.DEPLOY_PATH }}
          if [ -d "dist.backup" ]; then
            echo "âš ï¸ éƒ¨ç½²å¤±è´¥ï¼Œæ­£åœ¨å›žæ»š..."
            sudo rm -rf dist
            sudo mv dist.backup dist
            echo "âœ… å›žæ»šå®Œæˆ"
          fi

    - name: Deploy Summary
      if: always()
      run: |
        echo "## Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Target**: Production Server" >> $GITHUB_STEP_SUMMARY
        echo "- **Path**: ${{ env.DEPLOY_PATH }}/dist" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
