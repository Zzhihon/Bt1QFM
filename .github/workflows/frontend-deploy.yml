name: Frontend Deploy

on:
  push:
    branches:
      - master
    paths:
      - 'web/ui/**'
  workflow_dispatch:

permissions:
  contents: read

env:
  NODE_VERSION: '20'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Enable Corepack (for Yarn 4)
      run: corepack enable

    - name: Install dependencies
      working-directory: web/ui
      env:
        YARN_ENABLE_IMMUTABLE_INSTALLS: false
      run: yarn install

    - name: Build
      working-directory: web/ui
      run: yarn build

    - name: Package dist
      working-directory: web/ui
      run: tar -czvf dist.tar.gz dist/

    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -p ${{ secrets.DEPLOY_PORT }} ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

    - name: Upload and Deploy
      run: |
        # ä¸Šä¼ æ–‡ä»¶
        scp -P ${{ secrets.DEPLOY_PORT }} -i ~/.ssh/deploy_key \
          web/ui/dist.tar.gz \
          ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/opt/docker_file/website/nginx_website/website_file/1qfm/

        # éƒ¨ç½²
        ssh -p ${{ secrets.DEPLOY_PORT }} -i ~/.ssh/deploy_key \
          ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'ENDSSH'
          cd /opt/docker_file/website/nginx_website/website_file/1qfm

          echo "ðŸš€ å¼€å§‹éƒ¨ç½²å‰ç«¯..."

          echo "ðŸ“¦ å¤‡ä»½æ—§ç‰ˆæœ¬..."
          sudo rm -rf dist.backup
          if [ -d "dist" ]; then
            sudo mv dist dist.backup
          fi

          echo "ðŸ“¦ è§£åŽ‹æ–°ç‰ˆæœ¬..."
          tar -xzvf dist.tar.gz

          echo "ðŸ”§ è®¾ç½®æƒé™..."
          sudo chmod -R 755 dist/
          sudo chown -R root:root dist/

          echo "ðŸ§¹ æ¸…ç†..."
          rm -f dist.tar.gz

          echo "âœ… å‰ç«¯éƒ¨ç½²å®Œæˆ!"
          ls -la dist/
        ENDSSH

    - name: Cleanup SSH Key
      if: always()
      run: rm -f ~/.ssh/deploy_key

    - name: Deploy Summary
      if: always()
      run: |
        echo "## Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Target**: Production Server" >> $GITHUB_STEP_SUMMARY
        echo "- **Path**: /opt/docker_file/website/nginx_website/website_file/1qfm/dist" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
